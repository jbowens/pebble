example
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |    101  102B     0B     101 |   114B |   104B |    112  104B |  107B |    221  217B    0B |   1  2.09
    1 |    201  202B     0B     201 |   214B |   204B |    212  204B |  207B |    421  417B    0B |   2  2.04
    2 |    301  302B     0B     301 |   314B |   304B |    312  304B |  307B |    621  617B    0B |   3  2.03
    3 |    401  402B     0B     401 |   414B |   404B |    412  404B |  407B |    821  817B    0B |   4  2.02
    4 |    501  502B     0B     501 |   514B |   504B |    512  504B |  507B |   1.0K 1017B    0B |   5  2.02
    5 |    601  602B     0B     601 |   614B |   604B |    612  604B |  607B |   1.2K 1.2KB    0B |   6  2.01
    6 |    701  702B     0B     701 |   714B |   704B |    712  704B |  707B |   1.4K 1.4KB    0B |   7  2.01
total |   2.8K 2.7KB     0B    2.8K |  2.8KB |  2.8KB |   2.9K 2.8KB | 2.8KB |   5.7K 8.4KB    0B |  28  3.00
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |  1.10  2.10  0.30 |    113  106B |  104B  104B  104B
    1 |  1.20  2.20  0.60 |    213  206B |  204B  204B  204B
    2 |  1.30  2.30  0.90 |    313  306B |  304B  304B  304B
    3 |  1.40  2.40  1.20 |    413  406B |  404B  404B  404B
    4 |  1.50  2.50  1.50 |    513  506B |  504B  504B  504B
    5 |  1.60  2.60  1.80 |    613  606B |  604B  604B  604B
    6 |     0  2.70  2.10 |    713  706B |  704B  704B  704B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |         27        28        29        30        31        16        32        33        34

init
----

batch
set a 1
----

iter-new a category=a
----

flush
----
L0.0:
  000005:[a#10,SET-a#10,SET]

# iter b references both a memtable and sstable 5.

iter-new b category=b
----

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      1  755B     0B       0 |     0B |    28B |      0    0B |    0B |      1  755B    0B |   1 26.96
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
total |      1  755B     0B       0 |     0B |    28B |      0    0B |    0B |      1  783B    0B |   1 27.96
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.25  0.25 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0     0     0 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          0         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}

disk-usage
----
2.5KB

batch
set b 2
----

flush
----
L0.0:
  000005:[a#10,SET-a#10,SET]
  000007:[b#11,SET-b#11,SET]

# iter c references both a memtable and sstables 5 and 7.

iter-new c category=c
----

# Two files, since the target file size is set to 50.

compact a-z
----
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      0    0B     0B       0 |     0B |    64B |      0    0B |    0B |      2 1.5KB    0B |   0 23.59
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      2 1.5KB     0B       0 |     0B |  1.5KB |      0    0B | 1.5KB |      2 1.5KB    0B |   1  1.00
total |      2 1.5KB     0B       0 |     0B |    64B |      0    0B | 1.5KB |      4 3.0KB    0B |   1 48.28
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0     0     0 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:224 BlockBytesInCache:112 BlockReadDuration:10ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

disk-usage
----
4.9KB

# Closing iter a will release one of the zombie memtables.

iter-close a
----

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      0    0B     0B       0 |     0B |    64B |      0    0B |    0B |      2 1.5KB    0B |   0 23.59
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      2 1.5KB     0B       0 |     0B |  1.5KB |      0    0B | 1.5KB |      2 1.5KB    0B |   1  1.00
total |      2 1.5KB     0B       0 |     0B |    64B |      0    0B | 1.5KB |      4 3.0KB    0B |   1 48.28
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0     0     0 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:224 BlockBytesInCache:112 BlockReadDuration:10ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

# Closing iter c will release one of the zombie sstables. The other
# zombie sstable is still referenced by iter b.

iter-close c
----

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      0    0B     0B       0 |     0B |    64B |      0    0B |    0B |      2 1.5KB    0B |   0 23.59
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      2 1.5KB     0B       0 |     0B |  1.5KB |      0    0B | 1.5KB |      2 1.5KB    0B |   1  1.00
total |      2 1.5KB     0B       0 |     0B |    64B |      0    0B | 1.5KB |      4 3.0KB    0B |   1 48.28
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0     0     0 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:224 BlockBytesInCache:112 BlockReadDuration:10ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

disk-usage
----
4.1KB

# Closing iter b will release the last zombie sstable and the last zombie memtable.

iter-close b
----

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      0    0B     0B       0 |     0B |    64B |      0    0B |    0B |      2 1.5KB    0B |   0 23.59
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      2 1.5KB     0B       0 |     0B |  1.5KB |      0    0B | 1.5KB |      2 1.5KB    0B |   1  1.00
total |      2 1.5KB     0B       0 |     0B |    64B |      0    0B | 1.5KB |      4 3.0KB    0B |   1 48.28
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0     0     0 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:224 BlockBytesInCache:112 BlockReadDuration:10ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

disk-usage
----
3.4KB

additional-metrics
----
block bytes written:
 __level___data-block__value-block
      0         162B           0B
      1           0B           0B
      2           0B           0B
      3           0B           0B
      4           0B           0B
      5           0B           0B
      6         168B           0B

batch
set c@20 c20
set c@19 c19
set c@18 c18
set c@17 c17
set c@16 c16
set c@15 c15
set c@14 c14
----

flush
----
L0.0:
  000011:[c@20#12,SET-c@20#12,SET]
  000013:[c@19#13,SET-c@19#13,SET]
  000015:[c@18#14,SET-c@18#14,SET]
  000017:[c@17#15,SET-c@17#15,SET]
  000019:[c@16#16,SET-c@16#16,SET]
  000021:[c@15#17,SET-c@15#17,SET]
  000023:[c@14#18,SET-c@14#18,SET]
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      7 5.3KB     0B       0 |   413B |   165B |      0    0B |    0B |      9 6.8KB  826B |   1 12.75
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      2 1.5KB     0B       0 |     0B |  1.5KB |      0    0B | 1.5KB |      2 1.5KB    0B |   1  1.00
total |      9 6.8KB     0B       0 |   413B |   165B |      0    0B | 1.5KB |     11 8.4KB  826B |   2 15.66
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.25  0.25 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:224 BlockBytesInCache:112 BlockReadDuration:10ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

additional-metrics
----
block bytes written:
 __level___data-block__value-block
      0         827B           0B
      1           0B           0B
      2           0B           0B
      3           0B           0B
      4           0B           0B
      5           0B           0B
      6         168B           0B

compact a-z
----
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000025:[c@20#0,SET-c@20#0,SET]
  000026:[c@19#0,SET-c@19#0,SET]
  000027:[c@18#0,SET-c@18#0,SET]
  000028:[c@17#0,SET-c@17#0,SET]
  000029:[c@16#0,SET-c@16#0,SET]
  000030:[c@15#0,SET-c@15#0,SET]
  000031:[c@14#0,SET-c@14#0,SET]

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      0    0B     0B       0 |     0B |   165B |      0    0B |    0B |      9 6.8KB  826B |   0 12.75
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      9 6.8KB     0B       0 |   413B |  6.8KB |      0    0B | 6.8KB |      9 6.8KB    0B |   1  1.00
total |      9 6.8KB     0B       0 |   413B |   165B |      0    0B | 6.8KB |     18  14KB  826B |   1 25.05
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0     0     0 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          2         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:1106 BlockBytesInCache:112 BlockReadDuration:80ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

additional-metrics
----
block bytes written:
 __level___data-block__value-block
      0         827B           0B
      1           0B           0B
      2           0B           0B
      3           0B           0B
      4           0B           0B
      5           0B           0B
      6         818B           0B

# Flushable ingestion metrics. This requires there be data in a memtable that
# would overlap with the ingested table(s). Delayed flushes are disabled here to
# prevent the ingestion from immediately triggering a flush of the memtable.
# Instead, we wish to flush manually _after_ the ingestion of the two tables has
# completed, linking the two tables into the flushable queue.

delay-flush
enable
----

batch
set d d
set e e
set f f
----

build ext1.sst
set d d
----

build ext2.sst
set e e
----

ingest ext1.sst ext2.sst
----

build ext3.sst
set f f
----

ingest ext3.sst
----

delay-flush
disable
----

flush
----
L0.1:
  000032:[d#22,SET-d#22,SET]
  000033:[e#23,SET-e#23,SET]
  000036:[f#24,SET-f#24,SET]
L0.0:
  000040:[d#19,SET-d#19,SET]
  000041:[e#20,SET-e#20,SET]
  000042:[f#21,SET-f#21,SET]
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000025:[c@20#0,SET-c@20#0,SET]
  000026:[c@19#0,SET-c@19#0,SET]
  000027:[c@18#0,SET-c@18#0,SET]
  000028:[c@17#0,SET-c@17#0,SET]
  000029:[c@16#0,SET-c@16#0,SET]
  000030:[c@15#0,SET-c@15#0,SET]
  000031:[c@14#0,SET-c@14#0,SET]

# We expect the ingested-as-flushable count to be three (one for each ingested
# table). The unknown category in the iter category stats is because of a gap
# in instrumentation for checking overlap with an existing flushable ingest,
# where we open and close a point iterator when constructing a range-del
# iterator.
metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      6 4.4KB     0B       0 |     0B |   211B |      3 2.2KB |    0B |     12 9.0KB  826B |   2 15.44
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      9 6.8KB     0B       0 |   413B |  6.8KB |      0    0B | 6.8KB |      9 6.8KB    0B |   1  1.00
total |     15  11KB     0B       0 |   413B |  2.4KB |      3 2.2KB | 6.8KB |     21  18KB  826B |   3  6.58
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.50  0.50 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          2         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:1106 BlockBytesInCache:112 BlockReadDuration:80ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

batch
set g g
set h h
set i i
set j j
set k k
set l l
set m m
----

flush
----
L0.1:
  000032:[d#22,SET-d#22,SET]
  000033:[e#23,SET-e#23,SET]
  000036:[f#24,SET-f#24,SET]
L0.0:
  000040:[d#19,SET-d#19,SET]
  000041:[e#20,SET-e#20,SET]
  000042:[f#21,SET-f#21,SET]
  000044:[g#25,SET-g#25,SET]
  000045:[h#26,SET-h#26,SET]
  000046:[i#27,SET-i#27,SET]
  000047:[j#28,SET-j#28,SET]
  000048:[k#29,SET-k#29,SET]
  000049:[l#30,SET-l#30,SET]
  000050:[m#31,SET-m#31,SET]
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000025:[c@20#0,SET-c@20#0,SET]
  000026:[c@19#0,SET-c@19#0,SET]
  000027:[c@18#0,SET-c@18#0,SET]
  000028:[c@17#0,SET-c@17#0,SET]
  000029:[c@16#0,SET-c@16#0,SET]
  000030:[c@15#0,SET-c@15#0,SET]
  000031:[c@14#0,SET-c@14#0,SET]

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |     13 9.6KB     0B       0 |     0B |   277B |      3 2.2KB |    0B |     19  14KB  826B |   2 21.62
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      9 6.8KB     0B       0 |   413B |  6.8KB |      0    0B | 6.8KB |      9 6.8KB    0B |   1  1.00
total |     22  16KB     0B       0 |   413B |  2.5KB |      3 2.2KB | 6.8KB |     28  23KB  826B |   3  8.24
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.50  0.50 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          2         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:1106 BlockBytesInCache:112 BlockReadDuration:80ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

build ext1
set z z
----

ingest-and-excise ext1 excise=i-k
----

# sstable 29, 30 were created as virtual when i-k was excised.
lsm
----
L0.1:
  000032:[d#22,SET-d#22,SET]
  000033:[e#23,SET-e#23,SET]
  000036:[f#24,SET-f#24,SET]
L0.0:
  000040:[d#19,SET-d#19,SET]
  000041:[e#20,SET-e#20,SET]
  000042:[f#21,SET-f#21,SET]
  000044:[g#25,SET-g#25,SET]
  000045:[h#26,SET-h#26,SET]
  000048:[k#29,SET-k#29,SET]
  000049:[l#30,SET-l#30,SET]
  000050:[m#31,SET-m#31,SET]
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000025:[c@20#0,SET-c@20#0,SET]
  000026:[c@19#0,SET-c@19#0,SET]
  000027:[c@18#0,SET-c@18#0,SET]
  000028:[c@17#0,SET-c@17#0,SET]
  000029:[c@16#0,SET-c@16#0,SET]
  000030:[c@15#0,SET-c@15#0,SET]
  000031:[c@14#0,SET-c@14#0,SET]
  000051:[z#33,SET-z#33,SET]

# There should be 2 backing tables. Note that tiny sstables have inaccurate
# virtual sstable sizes.
metrics-value
num-backing
backing-size
num-virtual
num-virtual 0
virtual-size
----
0
0B
0
0
0B

metrics zero-cache-hits-misses
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |     11 8.1KB     0B       0 |     0B |   277B |      3 2.2KB |    0B |     19  14KB  826B |   2 21.62
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |     10 7.5KB     0B       0 |   413B |  6.8KB |      1  758B | 6.8KB |      9 6.8KB    0B |   1  1.00
total |     21  16KB     0B       0 |   413B |  3.2KB |      4 3.0KB | 6.8KB |     28  24KB  826B |   3  6.76
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.50  0.50 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          2         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:1106 BlockBytesInCache:112 BlockReadDuration:80ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

# Virtualize a virtual sstable.
build ext1
set zz zz
----

ingest-and-excise ext1 excise=k-l
----

# sstable 32 created when k-l was excised, but no new backing file should be
# created.
lsm
----
L0.1:
  000032:[d#22,SET-d#22,SET]
  000033:[e#23,SET-e#23,SET]
  000036:[f#24,SET-f#24,SET]
L0.0:
  000040:[d#19,SET-d#19,SET]
  000041:[e#20,SET-e#20,SET]
  000042:[f#21,SET-f#21,SET]
  000044:[g#25,SET-g#25,SET]
  000045:[h#26,SET-h#26,SET]
  000049:[l#30,SET-l#30,SET]
  000050:[m#31,SET-m#31,SET]
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000025:[c@20#0,SET-c@20#0,SET]
  000026:[c@19#0,SET-c@19#0,SET]
  000027:[c@18#0,SET-c@18#0,SET]
  000028:[c@17#0,SET-c@17#0,SET]
  000029:[c@16#0,SET-c@16#0,SET]
  000030:[c@15#0,SET-c@15#0,SET]
  000031:[c@14#0,SET-c@14#0,SET]
  000051:[z#33,SET-z#33,SET]
  000052:[zz#35,SET-zz#35,SET]

metrics-value
num-backing
backing-size
num-virtual
num-virtual 0
virtual-size
----
0
0B
0
0
0B

compact a-z
----
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000025:[c@20#0,SET-c@20#0,SET]
  000026:[c@19#0,SET-c@19#0,SET]
  000027:[c@18#0,SET-c@18#0,SET]
  000028:[c@17#0,SET-c@17#0,SET]
  000029:[c@16#0,SET-c@16#0,SET]
  000030:[c@15#0,SET-c@15#0,SET]
  000031:[c@14#0,SET-c@14#0,SET]
  000053:[d#0,SET-d#0,SET]
  000054:[e#0,SET-e#0,SET]
  000055:[f#0,SET-f#0,SET]
  000056:[g#0,SET-g#0,SET]
  000057:[h#0,SET-h#0,SET]
  000058:[l#0,SET-l#0,SET]
  000059:[m#0,SET-m#0,SET]
  000051:[z#33,SET-z#33,SET]
  000052:[zz#35,SET-zz#35,SET]

# Virtual sstables metrics should be gone after the compaction.
metrics-value
num-backing
backing-size
num-virtual
num-virtual 0
virtual-size
----
0
0B
0
0
0B

metrics zero-cache-hits-misses
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      0    0B     0B       0 |     0B |   277B |      3 2.2KB |    0B |     19  14KB  826B |   0 21.62
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |     18  13KB     0B       0 |   413B |   14KB |      2 1.5KB |  14KB |     16  12KB    0B |   1  0.84
total |     18  13KB     0B       0 |   413B |  4.0KB |      5 3.7KB |  14KB |     35  30KB  826B |   1  6.99
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0     0     0 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          3         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:2235 BlockBytesInCache:457 BlockReadDuration:150ms}
                   a, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
                   b,     latency: {BlockBytes:112 BlockBytesInCache:0 BlockReadDuration:10ms}
                   c, non-latency: {BlockBytes:112 BlockBytesInCache:112 BlockReadDuration:0s}

# Create a DB where lower levels are written as shared tables. All ingests also
# become shared tables.
init shared-lower
----

batch
set a 1
set b 1
set c 1
----

flush
----
L0.0:
  000005:[a#10,SET-a#10,SET]
  000006:[b#11,SET-b#11,SET]
  000007:[c#12,SET-c#12,SET]

# One local table.
metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      3 2.2KB     0B       0 |     0B |    38B |      0    0B |    0B |      3 2.2KB    0B |   1 59.61
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
total |      3 2.2KB     0B       0 |     0B |    38B |      0    0B |    0B |      3 2.2KB    0B |   1 60.61
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.25  0.25 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0     0     0 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          0         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}

compact a-z
----
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000010:[c#0,SET-c#0,SET]

# Table becomes shared, so local table size becomes 0.
metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      0    0B     0B       0 |     0B |    38B |      0    0B |    0B |      3 2.2KB    0B |   0 59.61
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      3 2.2KB     0B       0 |     0B |  2.2KB |      0    0B | 2.2KB |      3 2.2KB    0B |   1  1.00
total |      3 2.2KB     0B       0 |     0B |    38B |      0    0B | 2.2KB |      6 4.5KB    0B |   1 120.4
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0     0     0 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:336 BlockBytesInCache:0 BlockReadDuration:30ms}

build ext1.sst
set b 2
----

ingest ext1.sst
----

metrics-value
remote-count
remote-size
----
4
3.0KB

lsm
----
L0.0:
  000011:[b#13,SET-b#13,SET]
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000010:[c#0,SET-c#0,SET]

# Ingest is also shared table, so local table size stays 0.
metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      1  758B     0B       0 |     0B |    38B |      1  758B |    0B |      3 2.2KB    0B |   1 59.61
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      3 2.2KB     0B       0 |     0B |  2.2KB |      0    0B | 2.2KB |      3 2.2KB    0B |   1  1.00
total |      4 3.0KB     0B       0 |     0B |   796B |      1  758B | 2.2KB |      6 5.2KB    0B |   2  6.70
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.25  0.25 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:336 BlockBytesInCache:0 BlockReadDuration:30ms}

batch
set b 3
----

flush
----
L0.1:
  000013:[b#14,SET-b#14,SET]
L0.0:
  000011:[b#13,SET-b#13,SET]
L6:
  000008:[a#0,SET-a#0,SET]
  000009:[b#0,SET-b#0,SET]
  000010:[c#0,SET-c#0,SET]

# Local table size increases due to flush.
metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      2 1.5KB     0B       0 |     0B |    74B |      1  758B |    0B |      4 2.9KB    0B |   2 40.81
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      3 2.2KB     0B       0 |     0B |  2.2KB |      0    0B | 2.2KB |      3 2.2KB    0B |   1  1.00
total |      5 3.7KB     0B       0 |     0B |   832B |      1  758B | 2.2KB |      7 6.0KB    0B |   3  7.36
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.50  0.50 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:336 BlockBytesInCache:0 BlockReadDuration:30ms}

# Reopen DB, to ensure stats are consistent. Also, reopened DB is not
# configured to write shared tables.
init reopen
----

metrics zero-cache-hits-misses
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      2 1.5KB     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   2     0
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      3 2.2KB     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   1     0
total |      5 3.7KB     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   3     0
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.50  0.50 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          0         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}

compact a-z
----
L6:
  000008:[a#0,SET-a#0,SET]
  000018:[b#0,SET-b#0,SET]
  000010:[c#0,SET-c#0,SET]

# All tables are local after compaction.
metrics zero-cache-hits-misses
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      3 2.2KB     0B       0 |     0B |  1.5KB |      0    0B | 2.2KB |      1  758B    0B |   1  0.50
total |      3 2.2KB     0B       0 |     0B |     0B |      0    0B | 2.2KB |      1  758B    0B |   1     0
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0     0     0 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      0    0B |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          1         0         0         0         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:342 BlockBytesInCache:0 BlockReadDuration:30ms}

init
----

batch
set a 1
set b 2
----

flush
----
L0.0:
  000005:[a#10,SET-a#10,SET]
  000006:[b#11,SET-b#11,SET]

batch
del-sized c 500
----

flush
----
L0.0:
  000005:[a#10,SET-a#10,SET]
  000006:[b#11,SET-b#11,SET]
  000008:[c#12,DELSIZED-c#12,DELSIZED]

compact a-z parallel
----
L6:
  000005:[a#10,SET-a#10,SET]
  000006:[b#11,SET-b#11,SET]
  000008:[c#12,DELSIZED-c#12,DELSIZED]

batch
del-range a c
----

flush
----
L0.0:
  000010:[a#13,RANGEDEL-b#inf,RANGEDEL]
  000011:[b#13,RANGEDEL-c#inf,RANGEDEL]
L6:
  000005:[a#10,SET-a#10,SET]
  000006:[b#11,SET-b#11,SET]
  000008:[c#12,DELSIZED-c#12,DELSIZED]

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      2 1.5KB     0B       0 |     0B |   106B |      0    0B |    0B |      5 3.7KB    0B |   1 35.92
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      3 2.2KB     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   1     0
total |      5 3.7KB     0B       0 |     0B |   106B |      0    0B |    0B |      5 3.8KB    0B |   2 36.92
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.25  0.25 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      3 2.2KB |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          0         0         0         3         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}

problem-spans
L0 [a, c)
L6 [u, v]
----

metrics
----
LSM   |                             | valsep |        |   ingested   |       |       written      |    amp
level | tables  size val-bl vtables |  refsz |     in | tables  size |  read | tables tblsz blbsz |   r     w
------+-----------------------------+--------+--------+--------------+-------+--------------------+----------
    0 |      2 1.5KB     0B       0 |     0B |   106B |      0    0B |    0B |      5 3.7KB    0B |   1 35.92
    1 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    2 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    3 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    4 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    5 |      0    0B     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   0     0
    6 |      3 2.2KB     0B       0 |     0B |     0B |      0    0B |    0B |      0    0B    0B |   1     0
total |      5 3.7KB     0B       0 |     0B |   106B |      0    0B |    0B |      5 3.8KB    0B |   2 36.92
-------------------------------------------------------------------------------------------------------------
COMPACTIONS               |     moved    |     multilevel
level | score    ff   cff | tables  size |   top    in  read
------+-------------------+--------------+------------------
    0 |     0  0.25  0.25 |      0    0B |    0B    0B    0B
    1 |     0     0     0 |      0    0B |    0B    0B    0B
    2 |     0     0     0 |      0    0B |    0B    0B    0B
    3 |     0     0     0 |      0    0B |    0B    0B    0B
    4 |     0     0     0 |      0    0B |    0B    0B    0B
    5 |     0     0     0 |      0    0B |    0B    0B    0B
    6 |     0  0.00  0.00 |      3 2.2KB |    0B    0B    0B
-------------------------------------------------------------------------------------------------------
kind       |    default    delete   elision      move      read tombdense   rewrite      copy  multilvl
count      |          0         0         0         3         0         0         0         0         0
Iter category stats:
   pebble-compaction, non-latency: {BlockBytes:0 BlockBytesInCache:0 BlockReadDuration:0s}
